{% extends 'base.html' %}

{% block title %}Player Matrix - Smørås Fotball{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mb-4">Player Matrix</h1>
    
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <p class="card-text">
                This matrix shows which players have played together in matches. 
                Select a team to view the matrix for players in that team.
            </p>
            
            <div class="mb-3">
                <label for="teamSelect" class="form-label">Select Team:</label>
                <select id="teamSelect" class="form-select">
                    <option value="">-- Select a team --</option>
                    {% for team in teams %}
                    <option value="{{ team.id }}">{{ team.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>
    
    <div id="matrixContainer" class="card shadow-sm d-none">
        <div class="card-header bg-light">
            <h5 id="matrixTitle" class="mb-0">Player Matrix</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <div id="matrixLoading" class="text-center p-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading matrix data...</p>
                </div>
                <div id="matrixContent" class="d-none">
                    <table id="playerMatrix" class="table table-bordered matrix-table">
                        <!-- Matrix will be inserted here -->
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div id="noDataMessage" class="alert alert-info d-none">
        No players or match data found for the selected team.
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="/static/js/matrix.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const teamSelect = document.getElementById('teamSelect');
        const matrixContainer = document.getElementById('matrixContainer');
        const matrixTitle = document.getElementById('matrixTitle');
        const matrixLoading = document.getElementById('matrixLoading');
        const matrixContent = document.getElementById('matrixContent');
        const playerMatrix = document.getElementById('playerMatrix');
        const noDataMessage = document.getElementById('noDataMessage');
        
        // Function to create a color gradient based on value
        function getColorShade(value, max) {
            if (value === 0) return '#f8f9fa';
            const intensity = Math.min(Math.max(value / max, 0.1), 1);
            return `rgba(0, 123, 255, ${intensity})`;
        }
        
        teamSelect.addEventListener('change', function() {
            const teamId = this.value;
            
            if (teamId === '') {
                matrixContainer.classList.add('d-none');
                noDataMessage.classList.add('d-none');
                return;
            }
            
            // Show matrix container and loading
            matrixContainer.classList.remove('d-none');
            matrixLoading.classList.remove('d-none');
            matrixContent.classList.add('d-none');
            noDataMessage.classList.add('d-none');
            
            // Get team name
            const teamName = teamSelect.options[teamSelect.selectedIndex].text;
            matrixTitle.textContent = `Player Matrix - ${teamName}`;
            
            // Fetch player data for the team
            fetch(`/team/api/player-stats/?team_id=${teamId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    // Process data and create matrix
                    if (!data.players || data.players.length === 0) {
                        matrixContainer.classList.add('d-none');
                        noDataMessage.classList.remove('d-none');
                        return;
                    }
                    
                    const players = data.players;
                    const matrix = data.matrix;
                    const maxValue = data.max_value || 1;
                    
                    // Generate table HTML
                    let tableHTML = '<thead><tr><th></th>';
                    
                    // Add header row with player names
                    players.forEach(player => {
                        tableHTML += `<th>${player.first_name}</th>`;
                    });
                    tableHTML += '</tr></thead><tbody>';
                    
                    // Add rows for each player
                    players.forEach((player, rowIndex) => {
                        tableHTML += `<tr><th>${player.first_name}</th>`;
                        
                        // Add cells for each player
                        players.forEach((_, colIndex) => {
                            const value = matrix[rowIndex][colIndex];
                            const bgColor = getColorShade(value, maxValue);
                            tableHTML += `<td style="background-color: ${bgColor};" title="${value} matches together">${value}</td>`;
                        });
                        
                        tableHTML += '</tr>';
                    });
                    
                    tableHTML += '</tbody>';
                    playerMatrix.innerHTML = tableHTML;
                    
                    // Show matrix content
                    matrixLoading.classList.add('d-none');
                    matrixContent.classList.remove('d-none');
                })
                .catch(error => {
                    console.error('Error fetching matrix data:', error);
                    matrixContainer.classList.add('d-none');
                    noDataMessage.classList.remove('d-none');
                });
        });
    });
</script>
{% endblock %}

{% block extra_css %}
<style>
    .matrix-table th, .matrix-table td {
        text-align: center;
        width: 50px;
        height: 50px;
        font-size: 14px;
    }
    
    .matrix-table th {
        background-color: #f8f9fa;
        position: sticky;
        top: 0;
        z-index: 1;
    }
    
    .matrix-table th:first-child {
        position: sticky;
        left: 0;
        z-index: 2;
    }
    
    .matrix-table thead tr th:first-child {
        z-index: 3;
    }
</style>
{% endblock %}
