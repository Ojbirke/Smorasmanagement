{% extends 'base.html' %}

{% block title %}Dashboard - Smørås Fotball{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        transition: transform 0.3s;
    }
    .stat-card:hover {
        transform: translateY(-5px);
    }
    
    /* Matrix styles */
    .matrix-table th, .matrix-table td {
        text-align: center;
        width: 32px;
        height: 32px;
        font-size: 12px;
        padding: 2px;
    }
    
    .matrix-table th {
        background-color: #f8f9fa;
        position: sticky;
        top: 0;
        z-index: 1;
        font-weight: 600;
    }
    
    .matrix-table th:first-child {
        position: sticky;
        left: 0;
        z-index: 2;
    }
    
    .matrix-table thead tr th:first-child {
        z-index: 3;
    }
    
    .matrix-table td:hover {
        outline: 2px solid #198754;
        outline-offset: -2px;
    }

    /* Matrix container */
    .matrix-container {
        overflow: auto;
        max-height: 600px;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
    }
    
    /* Custom green color scale for the matrix cells, with stronger contrasts */
    .green-scale-0 { 
        background-color: #f8f9fa; 
        color: #adb5bd;
    }
    .green-scale-1 { 
        background-color: #eaf5ed; 
        color: #495057;
    }
    .green-scale-2 { 
        background-color: #d5ead9; 
        color: #495057;
    }
    .green-scale-3 { 
        background-color: #b6ddc1; 
        color: #495057;
    }
    .green-scale-4 { 
        background-color: #8ecfa0; 
        color: #212529;
    }
    .green-scale-5 { 
        background-color: #75c289; 
        color: #212529;
    }
    .green-scale-6 { 
        background-color: #5cb674; 
        color: #fff;
    }
    .green-scale-7 { 
        background-color: #42a95f; 
        color: #fff;
    }
    .green-scale-8 { 
        background-color: #309c4c; 
        color: #fff;
    }
    .green-scale-9 { 
        background-color: #1c8f38; 
        color: #fff;
        font-weight: bold;
    }
    .green-scale-10 { 
        background-color: #0a8127; 
        color: #fff;
        font-weight: bold;
        text-shadow: 0px 0px 1px rgba(0,0,0,0.3);
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mb-4">Dashboard</h1>
    
    <div class="row mb-4">
        <div class="col-md-4 mb-4">
            <div class="card stat-card h-100 border-primary shadow-sm">
                <div class="card-body text-center">
                    <h3 class="display-4 text-primary">{{ total_teams }}</h3>
                    <h5 class="card-title">Teams</h5>
                    <a href="{% url 'team-list' %}" class="btn btn-sm btn-outline-primary mt-2">View All Teams</a>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-4">
            <div class="card stat-card h-100 border-success shadow-sm">
                <div class="card-body text-center">
                    <h3 class="display-4 text-success">{{ total_players }}</h3>
                    <h5 class="card-title">Players</h5>
                    <a href="{% url 'player-list' %}" class="btn btn-sm btn-outline-success mt-2">View All Players</a>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-4">
            <div class="card stat-card h-100 border-info shadow-sm">
                <div class="card-body text-center">
                    <h3 class="display-4 text-info">{{ total_matches }}</h3>
                    <h5 class="card-title">Matches</h5>
                    <a href="{% url 'match-list' %}" class="btn btn-sm btn-outline-info mt-2">View All Matches</a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Team Performance</h5>
                </div>
                <div class="card-body">
                    <canvas id="teamPerformanceChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Player Match Count by Team</h5>
                </div>
                <div class="card-body">
                    <canvas id="playerMatchesChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Player Matrix Section -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Player Collaboration Matrix</h5>
            <span class="badge bg-success">Active Players Only</span>
        </div>
        <div class="card-body">
            <p class="card-text mb-3">
                This matrix shows which players have played together in matches across all teams.
                The darker green cells indicate players who have played together more frequently.
                Hover over cells to see exact match counts.
            </p>
            <div class="matrix-container">
                <div id="matrixLoading" class="text-center p-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading matrix data...</p>
                </div>
                <div id="matrixContent" class="d-none">
                    <table id="playerMatrix" class="table table-bordered matrix-table">
                        <!-- Matrix will be inserted here -->
                    </table>
                </div>
            </div>
            <div id="noDataMessage" class="alert alert-info d-none mt-3">
                No players or match data found.
            </div>
        </div>
    </div>
    
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Recent Matches</h5>
            <a href="{% url 'match-list' %}" class="btn btn-sm btn-outline-primary">View All</a>
        </div>
        <div class="card-body">
            {% if recent_matches %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Home Team</th>
                                <th>Away Team</th>
                                <th>Score</th>
                                <th>Result</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for match in recent_matches %}
                            <tr>
                                <td>{{ match.date|date:"d M Y" }}</td>
                                <td>{{ match.home_team }}</td>
                                <td>{{ match.away_team }}</td>
                                <td>
                                    {% if match.home_score is not None and match.away_score is not None %}
                                        {{ match.home_score }} - {{ match.away_score }}
                                    {% else %}
                                        Not played yet
                                    {% endif %}
                                </td>
                                <td>{{ match.get_result }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-info">No matches found.</div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="/static/js/charts.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Fetch team stats
        fetch('{% url "match-stats" %}')
            .then(response => response.json())
            .then(data => {
                const teams = data.map(item => item.team);
                const wins = data.map(item => item.wins);
                const draws = data.map(item => item.draws);
                const losses = data.map(item => item.losses);
                
                const ctx = document.getElementById('teamPerformanceChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: teams,
                        datasets: [
                            {
                                label: 'Wins',
                                data: wins,
                                backgroundColor: 'rgba(40, 167, 69, 0.7)'
                            },
                            {
                                label: 'Draws',
                                data: draws,
                                backgroundColor: 'rgba(108, 117, 125, 0.7)'
                            },
                            {
                                label: 'Losses',
                                data: losses,
                                backgroundColor: 'rgba(220, 53, 69, 0.7)'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: {
                                stacked: true,
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true
                            }
                        }
                    }
                });
            });
            
        // Fetch player stats for match count by team
        fetch('{% url "player-stats" %}')
            .then(response => response.json())
            .then(data => {
                // Sort players by total matches played
                data.sort((a, b) => (b.matches_played || 0) - (a.matches_played || 0));
                // Get top 10 players by match count
                const topPlayers = data.slice(0, 10);
                
                // Create player labels
                const playerLabels = topPlayers.map(player => 
                    player.first_name + (player.last_name ? ' ' + player.last_name.charAt(0) + '.' : '')
                );
                
                // Create datasets for each team
                // First, collect all team names
                const allTeams = new Set();
                topPlayers.forEach(player => {
                    if (player.teams) {
                        player.teams.forEach(team => {
                            allTeams.add(team.team__name);
                        });
                    }
                });
                
                // Convert to array and create color mapping
                const teamNames = Array.from(allTeams);
                const colorPalette = [
                    'rgba(40, 167, 69, 0.7)',    // green
                    'rgba(0, 123, 255, 0.7)',    // blue
                    'rgba(220, 53, 69, 0.7)',    // red
                    'rgba(255, 193, 7, 0.7)',    // yellow
                    'rgba(111, 66, 193, 0.7)',   // purple
                    'rgba(23, 162, 184, 0.7)',   // cyan
                    'rgba(108, 117, 125, 0.7)',  // gray
                    'rgba(253, 126, 20, 0.7)',   // orange
                    'rgba(32, 201, 151, 0.7)',   // teal
                    'rgba(102, 16, 242, 0.7)'    // indigo
                ];
                
                // Create a dataset for each team
                const datasets = teamNames.map((teamName, index) => {
                    // Generate data array for this team
                    const teamData = topPlayers.map(player => {
                        // Find matches for this player and team
                        const teamInfo = player.teams ? 
                            player.teams.find(t => t.team__name === teamName) : null;
                        return teamInfo ? teamInfo.team_matches : 0;
                    });
                    
                    return {
                        label: teamName,
                        data: teamData,
                        backgroundColor: colorPalette[index % colorPalette.length]
                    };
                });
                
                // Create the chart
                const ctx = document.getElementById('playerMatchesChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: playerLabels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Number of Matches by Player and Team'
                            },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        return context[0].label; // Player name
                                    },
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.raw} matches`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Players'
                                }
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Matches'
                                }
                            }
                        }
                    }
                });
            });
        
        // Player Matrix Visualization
        // Helper function to get color shade based on value
        function getColorShade(value, max) {
            if (value === 0) return 'green-scale-0'; // Light gray for zero
            
            // Use a stronger, more exponential curve for color intensity 
            // to better highlight differences at the higher end
            const factor = Math.pow(value / max, 0.7); // Using exponent < 1 gives more weight to higher values
            const intensity = Math.min(Math.ceil(factor * 10), 10);
            
            // Use predefined CSS classes for better coloring
            return `green-scale-${intensity}`;
        }
        
        // Get DOM elements for the matrix
        const matrixLoading = document.getElementById('matrixLoading');
        const matrixContent = document.getElementById('matrixContent');
        const playerMatrix = document.getElementById('playerMatrix');
        const noDataMessage = document.getElementById('noDataMessage');
        
        // Show loading indicator
        if (matrixLoading && matrixContent && playerMatrix && noDataMessage) {
            console.log('Matrix DOM elements found, fetching data...');
            matrixLoading.classList.remove('d-none');
            matrixContent.classList.add('d-none');
            noDataMessage.classList.add('d-none');
            
            // Fetch the matrix data from API
            fetch('{% url "player-matrix" %}')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Network error: ${response.status} ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Matrix data received:', data);
                    
                    if (!data.players || data.players.length === 0) {
                        console.log('No player data found');
                        matrixLoading.classList.add('d-none');
                        noDataMessage.classList.remove('d-none');
                        return;
                    }
                    
                    const players = data.players;
                    const matrix = data.matrix;
                    const maxValue = data.max_value || 1;
                    
                    // Generate table HTML
                    let tableHTML = '<thead><tr><th></th>';
                    
                    // Add header row with only first names for cleaner display
                    players.forEach(player => {
                        const displayName = player.first_name;
                        tableHTML += `<th>${displayName}</th>`;
                    });
                    tableHTML += '</tr></thead><tbody>';
                    
                    // Add rows for each player
                    players.forEach((player, rowIndex) => {
                        const displayName = player.first_name;
                        tableHTML += `<tr><th>${displayName}</th>`;
                        
                        // Add cells for each player
                        players.forEach((otherPlayer, colIndex) => {
                            const value = matrix[rowIndex][colIndex];
                            const colorClass = getColorShade(value, maxValue);
                            const fullName1 = `${player.first_name} ${player.last_name || ''}`.trim();
                            const fullName2 = `${otherPlayer.first_name} ${otherPlayer.last_name || ''}`.trim();
                            const title = value === 1 ? 
                                `${fullName1} played with ${fullName2} in ${value} match` : 
                                `${fullName1} played with ${fullName2} in ${value} matches`;
                            
                            tableHTML += `<td class="${colorClass}" title="${title}">${value}</td>`;
                        });
                        
                        tableHTML += '</tr>';
                    });
                    
                    tableHTML += '</tbody>';
                    
                    // Update the table
                    playerMatrix.innerHTML = tableHTML;
                    
                    // Show content
                    matrixLoading.classList.add('d-none');
                    matrixContent.classList.remove('d-none');
                    console.log('Matrix rendered successfully');
                })
                .catch(error => {
                    console.error('Error loading matrix data:', error);
                    matrixLoading.classList.add('d-none');
                    noDataMessage.classList.remove('d-none');
                    noDataMessage.textContent = `Error loading matrix data: ${error.message}`;
                });
        } else {
            console.error('One or more matrix DOM elements not found');
        }
    });
</script>
{% endblock %}
