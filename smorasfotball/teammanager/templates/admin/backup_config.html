{% extends "admin/base_site.html" %}
{% load i18n %}

{% block title %}{% translate "Backup Configuration" %}{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
  <a href="{% url 'admin:index' %}">{% translate "Home" %}</a> &rsaquo;
  {% translate "Backup Configuration" %}
</div>
{% endblock %}

{% block content %}
<div id="content-main">
  <h1>{% translate "Database Backup Configuration" %}</h1>
  
  {% if messages %}
  <ul class="messagelist">
    {% for message in messages %}
    <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
    {% endfor %}
  </ul>
  {% endif %}
  
  <div class="module">
    <h2>{% translate "Current Backup Configuration" %}</h2>
    
    <table>
      <tr>
        <th>{% translate "Primary Backup Directory" %}</th>
        <td>{{ backup_directory }}</td>
      </tr>
      <tr>
        <th>{% translate "Directory Status" %}</th>
        <td>
          {% if backup_dir_writable %}
          <span style="color: green;">✓ {% translate "Directory is writable" %}</span>
          {% else %}
          <span style="color: red;">✗ {% translate "Directory is not writable" %}</span>
          {% endif %}
        </td>
      </tr>
      <tr>
        <th>{% translate "Git Backup" %}</th>
        <td>
          {% if git_backup_enabled %}
          <span style="color: green;">✓ {% translate "Enabled" %}</span>
          {% else %}
          <span style="color: #999;">{% translate "Disabled" %}</span>
          {% endif %}
        </td>
      </tr>
      {% if git_backup_enabled %}
      <tr>
        <th>{% translate "Git Repository" %}</th>
        <td>{{ git_repo }}</td>
      </tr>
      <tr>
        <th>{% translate "Git Branch" %}</th>
        <td>{{ git_branch }}</td>
      </tr>
      <tr>
        <th>{% translate "Username" %}</th>
        <td>{{ git_username|default:"Not specified" }}</td>
      </tr>
      {% endif %}
    </table>
  </div>
  
  <div class="module">
    <h2>{% translate "Secondary Backup Locations" %}</h2>
    
    <table>
      <thead>
        <tr>
          <th>{% translate "Name" %}</th>
          <th>{% translate "Path" %}</th>
          <th>{% translate "Status" %}</th>
          <th>{% translate "Max Backups" %}</th>
        </tr>
      </thead>
      <tbody>
        {% for location in backup_locations %}
        <tr>
          <td>{{ location.name|default:"Location" }}</td>
          <td>{{ location.path }}</td>
          <td>
            {% if location.enabled %}
            <span style="color: green;">✓ {% translate "Enabled" %}</span>
            {% else %}
            <span style="color: #999;">{% translate "Disabled" %}</span>
            {% endif %}
          </td>
          <td>{{ location.max_backups|default:"5" }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="4">{% translate "No secondary backup locations configured." %}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  
  <form action="" method="post">
    {% csrf_token %}
    
    <div class="module">
      <h2>{% translate "Update Backup Configuration" %}</h2>
      
      <fieldset class="module aligned">
        <div class="form-row">
          <div>
            <label for="id_backup_directory">{% translate "Primary Backup Directory" %}:</label>
            <input type="text" name="backup_directory" id="id_backup_directory" value="{{ backup_directory }}" class="vTextField">
            <div class="help">
              {% translate "Absolute path to store backups outside the code repository." %}
            </div>
          </div>
        </div>
      </fieldset>
      
      <fieldset class="module aligned">
        <h3>{% translate "Git Backup Repository" %}</h3>
        
        <div class="form-row">
          <div>
            <label for="id_git_enabled">{% translate "Enable Git Backup" %}:</label>
            <input type="checkbox" name="git_enabled" id="id_git_enabled" {% if git_backup_enabled %}checked{% endif %}>
            <div class="help">
              {% translate "Store backups in a separate Git repository." %}
            </div>
          </div>
        </div>
        
        <div class="form-row">
          <div>
            <label for="id_git_repo">{% translate "Git Repository URL" %}:</label>
            <input type="text" name="git_repo" id="id_git_repo" value="{{ git_repo }}" class="vTextField">
            <div class="help">
              {% translate "URL of the Git repository for backups (e.g., https://github.com/username/repo.git)." %}
            </div>
          </div>
        </div>
        
        <div class="form-row">
          <div>
            <label for="id_git_branch">{% translate "Git Branch" %}:</label>
            <input type="text" name="git_branch" id="id_git_branch" value="{{ git_branch|default:'main' }}" class="vTextField">
            <div class="help">
              {% translate "Branch to use in the Git repository." %}
            </div>
          </div>
        </div>
        
        <div class="form-row">
          <div>
            <label for="id_git_username">{% translate "Git Username" %}:</label>
            <input type="text" name="git_username" id="id_git_username" value="{{ git_username }}" class="vTextField">
            <div class="help">
              {% translate "Username for Git authentication (if needed)." %}
            </div>
          </div>
        </div>
      </fieldset>
      
      <div class="submit-row">
        <input type="submit" name="save" value="{% translate 'Save Configuration' %}" class="default">
        <input type="submit" name="test" value="{% translate 'Test Backup Paths' %}">
      </div>
    </div>
  </form>
  
  <div class="module">
    <h2>{% translate "Manual Backup Tools" %}</h2>
    
    <p>{% translate "Use these commands to manually manage backups:" %}</p>
    
    <pre>
# Create a normal database backup
python manage.py backup_postgres

# Create a deployment backup (for use during redeployment)
python manage.py backup_postgres --deployment

# Sync backups with repository
python manage.py sync_backups_with_repo --push

# Pull backups from repository
python manage.py sync_backups_with_repo --pull

# Configure backup paths
python manage.py configure_backups --show-config 
python manage.py configure_backups --set-backup-path /path/to/backups
python manage.py configure_backups --test-backup-dir
python manage.py configure_backups --enable-git --git-repo https://github.com/username/repo.git
    </pre>
  </div>
</div>
{% endblock %}