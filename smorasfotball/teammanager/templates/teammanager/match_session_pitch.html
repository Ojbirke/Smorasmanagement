{% extends 'base.html' %}

{% block title %}Match Manager: {{ match_session.name }}{% endblock %}

{% block extra_head %}
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
    /* Mobile optimizations */
    body {
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
        overscroll-behavior: none;
    }
    
    .pitch-container {
        background-color: #3B7A12;
        border-radius: 8px;
        position: relative;
        margin-bottom: 1rem;
        height: 220px;
        overflow: hidden;
    }
    
    .pitch-markings {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        border: 2px solid rgba(255, 255, 255, 0.5);
        border-radius: 8px;
    }
    
    .center-circle {
        position: absolute;
        width: 60px;
        height: 60px;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        border: 2px solid rgba(255, 255, 255, 0.5);
        border-radius: 50%;
    }
    
    .center-mark {
        position: absolute;
        width: 6px;
        height: 6px;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(255, 255, 255, 0.5);
        border-radius: 50%;
    }
    
    .centerline {
        position: absolute;
        top: 0;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 2px;
        background-color: rgba(255, 255, 255, 0.5);
    }
    
    .player-on-pitch {
        position: absolute;
        width: 50px;
        height: 50px;
        transform: translate(-50%, -50%);
        border-radius: 50%;
        background-color: var(--bs-primary);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 0.8rem;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        cursor: pointer;
        z-index: 1;
        transition: transform 0.2s ease;
    }
    
    .player-on-pitch:active {
        transform: translate(-50%, -50%) scale(1.1);
    }
    
    .player-minutes {
        position: absolute;
        bottom: 2px;
        right: 2px;
        font-size: 0.6rem;
        background-color: rgba(0, 0, 0, 0.6);
        color: white;
        border-radius: 10px;
        padding: 1px 4px;
    }
    
    .player-bench-card {
        transition: transform 0.2s ease;
    }
    
    .player-bench-card:active {
        transform: scale(1.05);
    }
    
    .bench-container {
        max-height: 35vh;
        overflow-y: auto;
    }
    
    .timer-container {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    /* Custom toggle switch for active/inactive */
    .custom-switch {
        display: inline-block;
        height: 24px;
        position: relative;
        width: 48px;
    }
    
    .custom-switch input {
        display: none;
    }
    
    .slider {
        background-color: #ccc;
        bottom: 0;
        cursor: pointer;
        left: 0;
        position: absolute;
        right: 0;
        top: 0;
        transition: .4s;
        border-radius: 24px;
    }
    
    .slider:before {
        background-color: white;
        bottom: 4px;
        content: "";
        height: 16px;
        left: 4px;
        position: absolute;
        transition: .4s;
        width: 16px;
        border-radius: 50%;
    }
    
    input:checked + .slider {
        background-color: #198754;
    }
    
    input:checked + .slider:before {
        transform: translateX(24px);
    }
    
    /* Sub recommendation badge */
    .sub-recommend {
        position: absolute;
        top: -5px;
        right: -5px;
        width: 20px;
        height: 20px;
        background-color: #dc3545;
        border-radius: 50%;
        color: white;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
        0% {
            transform: scale(1);
            opacity: 1;
        }
        50% {
            transform: scale(1.2);
            opacity: 0.8;
        }
        100% {
            transform: scale(1);
            opacity: 1;
        }
    }
    
    /* Custom bottom action bar */
    .action-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        padding: 10px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 1000;
    }
    
    /* Adjust content so it's not hidden behind the action bar */
    .content-padding-bottom {
        padding-bottom: 70px;
    }
    
    /* Mobile-specific size adjustments */
    @media (max-width: 576px) {
        .player-on-pitch {
            width: 45px;
            height: 45px;
            font-size: 0.7rem;
        }
        
        .pitch-container {
            height: 180px;
        }
        
        h1 {
            font-size: 1.5rem;
        }
        
        h2 {
            font-size: 1.3rem;
        }
        
        .center-circle {
            width: 40px;
            height: 40px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-3 content-padding-bottom">
    <!-- Header with match info and status -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 mb-0">{{ match_session.name }}</h1>
        
        <div class="d-flex align-items-center">
            {% if can_edit %}
                {% if match_session.is_active %}
                    <a href="{% url 'match-session-stop' match_session.id %}" class="btn btn-sm btn-danger me-2">
                        <i class="bi bi-stop-circle"></i> Stop
                    </a>
                {% else %}
                    <a href="{% url 'match-session-start' match_session.id %}" class="btn btn-sm btn-success me-2">
                        <i class="bi bi-play-circle"></i> Start
                    </a>
                {% endif %}
            {% endif %}
            
            <a href="{% url 'match-session-detail' match_session.id %}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back
            </a>
        </div>
    </div>
    
    <!-- Match timer and period info -->
    <div class="timer-container mb-3">
        <div class="row align-items-center">
            <div class="col-6">
                <div class="fs-5">
                    {% if match_session.is_active %}
                        <span class="badge bg-success me-1">ACTIVE</span>
                        <span class="fw-bold">{{ current_game_time }}:00</span>
                    {% else %}
                        <span class="badge bg-secondary me-1">INACTIVE</span>
                        <span class="fw-bold">00:00</span>
                    {% endif %}
                </div>
                <div>
                    Period {{ current_period }}/{{ total_periods }}
                    {% if minutes_remaining is not None %}
                        <span class="text-muted">({{ minutes_remaining }} min left)</span>
                    {% endif %}
                </div>
            </div>
            
            <div class="col-6 text-end">
                <div class="small text-muted">
                    Manual substitutions only
                </div>
            </div>
        </div>
    </div>
    
    <!-- Football pitch visualization -->
    <div class="pitch-container">
        <div class="pitch-markings"></div>
        <div class="centerline"></div>
        <div class="center-circle"></div>
        <div class="center-mark"></div>
        
        <!-- Players on pitch -->
        {% for player in on_pitch %}
            <div class="player-on-pitch" id="player-{{ player.player.id }}" 
                 style="top: 50%; left: {% widthratio forloop.counter on_pitch.count|add:1 100 %}%;"
                 data-player-id="{{ player.player.id }}"
                 data-player-name="{{ player.player.first_name }}">
                {{ player.player.first_name }}
                <span class="player-minutes">{{ player.minutes_played }}m</span>
                
                {% if player.minutes_played < 10 %}
                    <span class="sub-recommend">!</span>
                {% endif %}
            </div>
        {% endfor %}
    </div>
    
    <!-- Controls for player rotation -->
    <div class="card shadow-sm mb-3">
        <div class="card-header bg-primary text-white">
            <h2 class="h5 mb-0">On Pitch ({{ on_pitch.count }})</h2>
        </div>
        <div class="card-body p-0">
            <div class="list-group list-group-flush">
                {% for player in on_pitch %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <span class="fw-bold">{{ player.player.first_name }}</span>
                            <small class="d-block text-muted">
                                <span id="pitch-time-{{ player.player.id }}">{{ player.minutes_played }}</span> minutes played
                                <span class="badge bg-success">on pitch</span>
                            </small>
                        </div>
                        
                        {% if match_session.is_active and can_edit and on_bench.count > 0 %}
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-primary dropdown-toggle" 
                                       type="button" data-bs-toggle="dropdown">
                                    Sub Out
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    {% for bench_player in on_bench %}
                                        <li>
                                            <a class="dropdown-item quick-sub-link" 
                                               href="#" 
                                               data-player-in="{{ bench_player.player.id }}" 
                                               data-player-out="{{ player.player.id }}"
                                               data-session="{{ match_session.id }}">
                                                {{ bench_player.player.first_name }} ({{ bench_player.minutes_played }}m)
                                            </a>
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endif %}
                    </div>
                {% empty %}
                    <div class="list-group-item text-center">No players on pitch</div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- Bench players -->
    <div class="card shadow-sm mb-3">
        <div class="card-header bg-secondary text-white">
            <h2 class="h5 mb-0">Bench ({{ on_bench.count }})</h2>
        </div>
        <div class="card-body p-0 bench-container">
            <div class="list-group list-group-flush">
                {% for player in on_bench %}
                    <div class="list-group-item d-flex justify-content-between align-items-center player-bench-card">
                        <div>
                            <span class="fw-bold">{{ player.player.first_name }}</span>
                            <small class="d-block text-muted">
                                <span id="bench-time-{{ player.player.id }}">{{ player.minutes_played }}</span> minutes played
                                <span class="badge bg-secondary">on bench</span>
                            </small>
                        </div>
                        
                        {% if match_session.is_active and can_edit and on_pitch.count > 0 %}
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-success dropdown-toggle" 
                                       type="button" data-bs-toggle="dropdown">
                                    Sub In
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    {% for pitch_player in on_pitch %}
                                        <li>
                                            <a class="dropdown-item quick-sub-link" 
                                               href="#" 
                                               data-player-in="{{ player.player.id }}" 
                                               data-player-out="{{ pitch_player.player.id }}"
                                               data-session="{{ match_session.id }}">
                                                For {{ pitch_player.player.first_name }} ({{ pitch_player.minutes_played }}m)
                                            </a>
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endif %}
                    </div>
                {% empty %}
                    <div class="list-group-item text-center">No players on bench</div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Fixed action bar at the bottom -->
<div class="action-bar">
    <div>
        <span class="fw-bold">Players:</span> 
        <span class="badge bg-primary">{{ on_pitch.count }}</span> on / 
        <span class="badge bg-secondary">{{ on_bench.count }}</span> bench
    </div>
    
    <div>
        {% if match_session.is_active %}
            <button id="recommendSubBtn" class="btn btn-success me-2">
                <i class="bi bi-lightbulb"></i> Recommend Subs
            </button>
            <a href="{% url 'substitution-create' match_session.id %}" class="btn btn-primary">
                <i class="bi bi-arrow-left-right"></i> Manual Sub
            </a>
        {% else %}
            <a href="{% url 'match-session-players' match_session.id %}" class="btn btn-primary">
                <i class="bi bi-people"></i> Edit Players
            </a>
        {% endif %}
    </div>
</div>

<!-- Modal for confirming substitution -->
<div class="modal fade" id="subConfirmModal" tabindex="-1" aria-labelledby="subConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="subConfirmModalLabel">Confirm Substitution</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="subConfirmBody">
                Are you sure you want to make this substitution?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmSubBtn">Confirm</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for auto-sub recommendation -->
<div class="modal fade" id="autoSubModal" tabindex="-1" aria-labelledby="autoSubModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="autoSubModalLabel">Recommended Substitutions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">Based on playing time, we recommend these substitutions:</p>
                
                <div id="autoSubSuggestions" class="list-group">
                    <!-- Will be filled dynamically -->
                </div>
                <div class="d-none" id="bulkActionsContainer">
                    <hr>
                    <div class="d-flex justify-content-end mt-3">
                        <button id="applySelectedSubsBtn" class="btn btn-success">
                            <i class="bi bi-check2-all"></i> Apply Selected Substitutions
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for substitution result -->
<div class="modal fade" id="subResultModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Substitution Made</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="subResultBody">
                Substitution successful!
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Elements
        const quickSubLinks = document.querySelectorAll('.quick-sub-link');
        const subConfirmModal = document.getElementById('subConfirmModal');
        
        // Function to handle multiple substitutions at once
        function applyMultipleSubstitutions(substitutions) {
            if (!substitutions || substitutions.length === 0) return;
            
            // Create a summary of what will be done
            let confirmMessage = '<p>Are you sure you want to make these substitutions?</p><div class="mt-3">';
            
            substitutions.forEach((sub, index) => {
                confirmMessage += `
                    <div class="d-flex align-items-center mb-3 ${index < substitutions.length - 1 ? 'border-bottom pb-2' : ''}">
                        <div class="text-center">
                            <span class="fw-bold">${index + 1}.</span>
                        </div>
                        <div class="d-flex align-items-center flex-grow-1 mx-3">
                            <div class="text-center me-2">
                                <div class="badge bg-secondary p-2">${sub.playerOutName}</div>
                                <div class="small">OUT</div>
                            </div>
                            <div class="mx-2"><i class="bi bi-arrow-left-right"></i></div>
                            <div class="text-center ms-2">
                                <div class="badge bg-success p-2">${sub.playerInName}</div>
                                <div class="small">IN</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            confirmMessage += '</div>';
            
            // Show the confirmation modal
            subConfirmBody.innerHTML = confirmMessage;
            
            // Set up the confirmation button to process all substitutions
            const confirmHandler = function() {
                // Remove the event listener to prevent multiple calls
                confirmSubBtn.removeEventListener('click', confirmHandler);
                
                // Hide the modal
                bsSubConfirmModal.hide();
                
                // Process each substitution sequentially with Promises
                let promise = Promise.resolve();
                let results = [];
                
                substitutions.forEach(sub => {
                    promise = promise.then(() => {
                        return fetch(`/team/match-sessions/${sub.sessionId}/quick-sub/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Requested-With': 'XMLHttpRequest',
                                'X-CSRFToken': getCookie('csrftoken')
                            },
                            body: JSON.stringify({
                                player_in: sub.playerIn,
                                player_out: sub.playerOut
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                results.push({
                                    success: true,
                                    playerIn: data.player_in,
                                    playerOut: data.player_out,
                                    minute: data.minute,
                                    period: data.period
                                });
                            } else {
                                results.push({
                                    success: false,
                                    error: data.error || 'Unknown error',
                                    playerInName: sub.playerInName,
                                    playerOutName: sub.playerOutName
                                });
                            }
                            return results;
                        });
                    });
                });
                
                // After all substitutions are processed
                promise.then(allResults => {
                    // Show results summary
                    let resultMessage = '<div class="alert alert-success mb-3"><strong>Multiple substitutions completed</strong></div>';
                    
                    // Count successes and failures
                    const successes = results.filter(r => r.success).length;
                    
                    resultMessage += `<p>${successes} of ${results.length} substitutions were successful.</p><div class="mt-3">`;
                    
                    // List all substitutions with success/failure status
                    results.forEach((result, index) => {
                        if (result.success) {
                            resultMessage += `
                                <div class="d-flex align-items-center mb-2 ${index < results.length - 1 ? 'border-bottom pb-2' : ''}">
                                    <div class="text-success me-2"><i class="bi bi-check-circle-fill"></i></div>
                                    <div>${result.playerIn} replaced ${result.playerOut} at ${result.minute}' in period ${result.period}</div>
                                </div>
                            `;
                        } else {
                            resultMessage += `
                                <div class="d-flex align-items-center mb-2 ${index < results.length - 1 ? 'border-bottom pb-2' : ''}">
                                    <div class="text-danger me-2"><i class="bi bi-x-circle-fill"></i></div>
                                    <div>Failed to substitute ${result.playerInName} for ${result.playerOutName}: ${result.error}</div>
                                </div>
                            `;
                        }
                    });
                    
                    resultMessage += '</div>';
                    
                    // Display results in the result modal
                    subResultBody.innerHTML = resultMessage;
                    bsSubResultModal.show();
                    
                    // Reload the page after dismissing the result modal
                    subResultModal.addEventListener('hidden.bs.modal', function () {
                        window.location.reload();
                    }, { once: true });
                })
                .catch(error => {
                    console.error('Error processing substitutions:', error);
                    subResultBody.innerHTML = `
                        <div class="alert alert-danger">
                            <p class="mb-0"><strong>Error:</strong> An error occurred while processing the substitutions.</p>
                        </div>
                    `;
                    bsSubResultModal.show();
                });
            };
            
            // Add event listener for confirmation
            confirmSubBtn.addEventListener('click', confirmHandler);
            
            // Show the confirmation modal
            bsSubConfirmModal.show();
        }
        const subConfirmBody = document.getElementById('subConfirmBody');
        const confirmSubBtn = document.getElementById('confirmSubBtn');
        const recommendSubBtn = document.getElementById('recommendSubBtn');
        const autoSubModal = document.getElementById('autoSubModal');
        const autoSubSuggestions = document.getElementById('autoSubSuggestions');
        const subResultModal = document.getElementById('subResultModal');
        const subResultBody = document.getElementById('subResultBody');
        
        // Bootstrap modals
        const bsSubConfirmModal = new bootstrap.Modal(subConfirmModal);
        const bsAutoSubModal = new bootstrap.Modal(autoSubModal);
        const bsSubResultModal = new bootstrap.Modal(subResultModal);
        
        // Substitution data
        let currentSubData = null;
        
        // Handle quick sub links
        quickSubLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                const playerIn = this.dataset.playerIn;
                const playerOut = this.dataset.playerOut;
                const sessionId = this.dataset.session;
                
                // Get player names
                const playerInName = this.textContent.trim().split('(')[0].trim();
                const playerOutName = this.closest('.dropdown').previousElementSibling.querySelector('.fw-bold').textContent.trim();
                
                // Set confirmation message
                subConfirmBody.innerHTML = `
                    <p>Are you sure you want to make this substitution?</p>
                    <div class="d-flex align-items-center justify-content-center my-3">
                        <div class="text-center me-3">
                            <div class="badge bg-secondary p-2 mb-2">${playerOutName}</div>
                            <div><i class="bi bi-arrow-right fs-3"></i></div>
                            <div class="small">OUT</div>
                        </div>
                        <div class="fs-3 mx-3"><i class="bi bi-arrow-left-right"></i></div>
                        <div class="text-center ms-3">
                            <div class="badge bg-success p-2 mb-2">${playerInName}</div>
                            <div><i class="bi bi-arrow-left fs-3"></i></div>
                            <div class="small">IN</div>
                        </div>
                    </div>
                `;
                
                // Store data for confirmation
                currentSubData = {
                    playerIn,
                    playerOut,
                    sessionId
                };
                
                // Show confirmation modal
                bsSubConfirmModal.show();
            });
        });
        
        // Handle confirmation button click
        confirmSubBtn.addEventListener('click', function() {
            if (!currentSubData) return;
            
            // Hide confirmation modal
            bsSubConfirmModal.hide();
            
            // Send AJAX request to make the substitution
            fetch(`/team/match-sessions/${currentSubData.sessionId}/quick-sub/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    player_in: currentSubData.playerIn,
                    player_out: currentSubData.playerOut
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    subResultBody.innerHTML = `
                        <div class="alert alert-success">
                            <p class="mb-1"><strong>Substitution successful!</strong></p>
                            <p class="mb-0">
                                <span class="fw-bold">${data.player_in}</span> has replaced 
                                <span class="fw-bold">${data.player_out}</span> 
                                at ${data.minute}' in period ${data.period}.
                            </p>
                        </div>
                    `;
                    bsSubResultModal.show();
                    
                    // Reload the page after dismissing the result modal
                    subResultModal.addEventListener('hidden.bs.modal', function () {
                        window.location.reload();
                    }, { once: true });
                } else {
                    subResultBody.innerHTML = `
                        <div class="alert alert-danger">
                            <p class="mb-0"><strong>Error:</strong> ${data.error}</p>
                        </div>
                    `;
                    bsSubResultModal.show();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                subResultBody.innerHTML = `
                    <div class="alert alert-danger">
                        <p class="mb-0"><strong>Error:</strong> An error occurred while making the substitution.</p>
                    </div>
                `;
                bsSubResultModal.show();
            });
        });
        
        // Auto-substitution functionality has been disabled as requested by the user
        // The auto-sub button has been removed from the UI and the automatic substitution
        // logic has been commented out. All substitutions are now manual only.
        
        // Handle recommendation button click
        if (recommendSubBtn) {
            recommendSubBtn.addEventListener('click', function() {
                // Clear previous recommendations
                autoSubSuggestions.innerHTML = '';
                
                // Show loading state
                autoSubSuggestions.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Loading recommendations...</p></div>';
                
                // Show modal while loading
                bsAutoSubModal.show();
                
                // Get recommendations
                fetch(`/team/match-sessions/{{ match_session.id }}/recommendations/`, {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Clear loading indicator
                        autoSubSuggestions.innerHTML = '';
                        
                        if (data.recommendations.length === 0) {
                            // No recommendations
                            autoSubSuggestions.innerHTML = '<div class="alert alert-info">No recommendations available at this time. This could be because all players have similar playing times or there are not enough players on the bench.</div>';
                        } else {
                            // Build recommendations UI
                            data.recommendations.forEach((rec, index) => {
                                const recItem = document.createElement('div');
                                recItem.className = 'list-group-item';
                                
                                // Create recommendation list item with checkbox
                                recItem.innerHTML = `
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div class="form-check form-check-inline me-2">
                                            <input class="form-check-input rec-checkbox" type="checkbox" 
                                                id="rec-check-${index}" 
                                                data-player-in="${rec.player_in_id}" 
                                                data-player-out="${rec.player_out_id}"
                                                data-player-in-name="${rec.player_in_name}"
                                                data-player-out-name="${rec.player_out_name}"
                                                data-session="{{ match_session.id }}">
                                        </div>
                                        <div class="d-flex align-items-center flex-grow-1">
                                            <div class="text-center me-3">
                                                <div class="badge bg-secondary p-2 mb-2">${rec.player_out_name}</div>
                                                <div class="small text-muted">${rec.player_out_minutes} mins played</div>
                                            </div>
                                            <div class="fs-4 mx-3"><i class="bi bi-arrow-left-right"></i></div>
                                            <div class="text-center ms-3">
                                                <div class="badge bg-success p-2 mb-2">${rec.player_in_name}</div>
                                                <div class="small text-muted">${rec.player_in_minutes} mins played</div>
                                                ${rec.bench_minutes ? `<div class="small text-info">${rec.bench_minutes} mins on bench</div>` : ''}
                                            </div>
                                        </div>
                                        <button class="btn btn-sm btn-primary apply-rec-btn" 
                                            data-player-in="${rec.player_in_id}" 
                                            data-player-out="${rec.player_out_id}"
                                            data-session="{{ match_session.id }}">
                                            Apply
                                        </button>
                                    </div>
                                    <div class="small text-muted">${rec.reason}</div>
                                `;
                                
                                autoSubSuggestions.appendChild(recItem);
                            });
                            
                            // Show the bulk actions container
                            document.getElementById('bulkActionsContainer').classList.remove('d-none');
                            
                            // Add event listeners to checkboxes
                            document.querySelectorAll('.rec-checkbox').forEach(checkbox => {
                                checkbox.addEventListener('change', function() {
                                    // Check if any checkboxes are selected
                                    const anyChecked = document.querySelectorAll('.rec-checkbox:checked').length > 0;
                                    // Show/hide apply button based on selection
                                    document.getElementById('applySelectedSubsBtn').classList.toggle('d-none', !anyChecked);
                                });
                            });
                            
                            // Add event listener to the apply selected button
                            document.getElementById('applySelectedSubsBtn').addEventListener('click', function() {
                                const checkedBoxes = document.querySelectorAll('.rec-checkbox:checked');
                                if (checkedBoxes.length === 0) return;
                                
                                // Close recommendation modal
                                bsAutoSubModal.hide();
                                
                                // Prepare substitutions data
                                const substitutions = Array.from(checkedBoxes).map(checkbox => ({
                                    playerIn: checkbox.dataset.playerIn,
                                    playerOut: checkbox.dataset.playerOut,
                                    playerInName: checkbox.dataset.playerInName,
                                    playerOutName: checkbox.dataset.playerOutName,
                                    sessionId: checkbox.dataset.session
                                }));
                                
                                // Apply substitutions one by one
                                applyMultipleSubstitutions(substitutions);
                            });
                            
                            // Add event listeners to the Apply buttons
                            document.querySelectorAll('.apply-rec-btn').forEach(btn => {
                                btn.addEventListener('click', function() {
                                    const playerIn = this.dataset.playerIn;
                                    const playerOut = this.dataset.playerOut;
                                    const sessionId = this.dataset.session;
                                    
                                    // Close recommendation modal
                                    bsAutoSubModal.hide();
                                    
                                    // Get player names from the surrounding elements
                                    const playerInName = this.closest('.list-group-item').querySelector('.badge.bg-success').textContent.trim();
                                    const playerOutName = this.closest('.list-group-item').querySelector('.badge.bg-secondary').textContent.trim();
                                    
                                    // Set up confirmation modal
                                    subConfirmBody.innerHTML = `
                                        <p>Are you sure you want to make this substitution?</p>
                                        <div class="d-flex align-items-center justify-content-center my-3">
                                            <div class="text-center me-3">
                                                <div class="badge bg-secondary p-2 mb-2">${playerOutName}</div>
                                                <div><i class="bi bi-arrow-right fs-3"></i></div>
                                                <div class="small">OUT</div>
                                            </div>
                                            <div class="fs-3 mx-3"><i class="bi bi-arrow-left-right"></i></div>
                                            <div class="text-center ms-3">
                                                <div class="badge bg-success p-2 mb-2">${playerInName}</div>
                                                <div><i class="bi bi-arrow-left fs-3"></i></div>
                                                <div class="small">IN</div>
                                            </div>
                                        </div>
                                    `;
                                    
                                    // Store data for confirmation
                                    currentSubData = {
                                        playerIn,
                                        playerOut,
                                        sessionId
                                    };
                                    
                                    // Show confirmation modal
                                    bsSubConfirmModal.show();
                                });
                            });
                        }
                    } else {
                        // Error fetching recommendations
                        autoSubSuggestions.innerHTML = `<div class="alert alert-danger">Error getting recommendations: ${data.error || 'Unknown error'}</div>`;
                    }
                })
                .catch(error => {
                    console.error('Error getting recommendations:', error);
                    autoSubSuggestions.innerHTML = '<div class="alert alert-danger">Error communicating with the server. Please try again.</div>';
                });
            });
        }
        
        // Function to get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // Auto-update playing times
        {% if match_session.is_active %}
        let updateTimerInterval;
        let clockInterval;
        let currentGameTime = {{ current_game_time|default:0 }};
        let matchStartTime = {% if match_session.start_time %}new Date("{{ match_session.start_time|date:'c' }}"){% else %}null{% endif %};
        let currentPeriod = {{ current_period|default:1 }};
        
        function startAutoRefresh() {
            // First immediate update
            updatePlayingTimes();
            
            // Then set interval for more frequent updates (every 5 seconds)
            updateTimerInterval = setInterval(updatePlayingTimes, 5000);
            
            // Start the clock that updates every second
            startClock();
        }
        
        function startClock() {
            // Clear existing interval if there is one
            if (clockInterval) {
                clearInterval(clockInterval);
            }
            
            // Set up the clock to update every second
            clockInterval = setInterval(updateClock, 1000);
        }
        
        function updateClock() {
            if (!matchStartTime) return;
            
            // Calculate current match time in seconds
            const now = new Date();
            const elapsedSeconds = Math.floor((now - matchStartTime) / 1000);
            const elapsedMinutes = Math.floor(elapsedSeconds / 60);
            const elapsedSecondsInMinute = elapsedSeconds % 60;
            
            // Update the match clock
            const matchInfoEl = document.querySelector('.fw-bold');
            if (matchInfoEl) {
                matchInfoEl.textContent = `${elapsedMinutes}:${elapsedSecondsInMinute.toString().padStart(2, '0')}`;
            }
            
            // Real-time update for player times (on pitch)
            const playersOnPitch = document.querySelectorAll('.player-on-pitch');
            playersOnPitch.forEach(player => {
                const playerId = player.id.replace('player-', '');
                const minutesEl = player.querySelector('.player-minutes');
                if (minutesEl) {
                    const currentMinutes = parseInt(minutesEl.textContent);
                    // If player is on pitch, increment their time based on realtime
                    const lastUpdate = window.lastPlayerUpdate || 0;
                    const currentMinute = Math.floor(elapsedSeconds / 60);
                    // Update display if it's a new minute
                    if (currentMinute > lastUpdate) {
                        window.lastPlayerUpdate = currentMinute;
                        // Update all player times
                        updatePlayerTimes();
                    }
                }
            });
            
            // Update period if needed (only when a full minute passes)
            if (elapsedMinutes !== currentGameTime) {
                currentGameTime = elapsedMinutes;
                const newPeriod = Math.min(Math.floor(elapsedMinutes / {{ period_length }}) + 1, {{ total_periods }});
                
                if (newPeriod !== currentPeriod) {
                    currentPeriod = newPeriod;
                    const periodInfoEl = document.querySelector('.col-6 > div:nth-child(2)');
                    if (periodInfoEl) {
                        periodInfoEl.innerHTML = `Period ${currentPeriod}/{{ total_periods }}`;
                    }
                }
            }
        }
        
        // Separate function to update player times that can be called by both functions
        function updatePlayerTimes() {
            fetch(`/team/match-sessions/{{ match_session.id }}/update-times/`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update player times on cards and bubbles
                    for (const playerId in data.playing_times) {
                        const playerData = data.playing_times[playerId];
                        
                        // Update on pitch player bubbles
                        const playerOnPitch = document.getElementById(`player-${playerId}`);
                        if (playerOnPitch) {
                            const minutesEl = playerOnPitch.querySelector('.player-minutes');
                            if (minutesEl) {
                                minutesEl.textContent = `${playerData.minutes}m`;
                            }
                        }
                        
                        // Update player list times - Using IDs for more reliable updates
                        if (playerData.on_pitch) {
                            // Update pitch player time
                            const pitchTimeEl = document.getElementById(`pitch-time-${playerId}`);
                            if (pitchTimeEl) {
                                pitchTimeEl.textContent = playerData.minutes;
                            }
                        } else {
                            // Update bench player time
                            const benchTimeEl = document.getElementById(`bench-time-${playerId}`);
                            if (benchTimeEl) {
                                benchTimeEl.textContent = playerData.minutes;
                                
                                // Find the badge element and update it to show bench time
                                const parent = benchTimeEl.closest('.text-muted');
                                if (parent) {
                                    const badge = parent.querySelector('.badge');
                                    if (badge) {
                                        badge.textContent = `${playerData.bench_minutes}m on bench`;
                                    }
                                }
                            }
                        }
                    }
                }
            })
            .catch(error => {
                console.error('Error updating player times:', error);
            });
        }
        
        function updatePlayingTimes() {
            // Use the updatePlayerTimes function to update player times
            updatePlayerTimes();
            
            // Additionally, update the match info
            fetch(`/team/match-sessions/{{ match_session.id }}/update-times/`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update match data if needed 
                    matchStartTime = data.match_info.start_time ? new Date(data.match_info.start_time) : matchStartTime;
                    
                    // Update period info
                    const periodInfoEl = document.querySelector('.col-6 > div:nth-child(2)');
                    if (periodInfoEl) {
                        periodInfoEl.innerHTML = `Period ${data.match_info.period}/{{ total_periods }}`;
                        currentPeriod = data.match_info.period;
                    }
                }
            })
            .catch(error => {
                console.error('Error updating match time info:', error);
            });
        }
        
        // Start auto-refresh when page loads
        startAutoRefresh();
        
        // Clean up when page is unloaded
        window.addEventListener('beforeunload', function() {
            if (updateTimerInterval) {
                clearInterval(updateTimerInterval);
            }
            if (clockInterval) {
                clearInterval(clockInterval);
            }
        });
        {% endif %}
        
        // Players dragging on pitch (simple implementation)
        const playersOnPitch = document.querySelectorAll('.player-on-pitch');
        const pitchContainer = document.querySelector('.pitch-container');
        
        if (pitchContainer && playersOnPitch.length > 0) {
            // Just for visualization, actual positions not saved in this basic implementation
            playersOnPitch.forEach(player => {
                let isDragging = false;
                let startX, startY;
                let originalLeft, originalTop;
                
                // Touch events for mobile
                player.addEventListener('touchstart', function(e) {
                    isDragging = true;
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                    originalLeft = parseInt(player.style.left);
                    originalTop = parseInt(player.style.top);
                    player.style.zIndex = 10;
                    e.preventDefault();
                });
                
                document.addEventListener('touchmove', function(e) {
                    if (!isDragging) return;
                    
                    const pitchRect = pitchContainer.getBoundingClientRect();
                    const touchX = e.touches[0].clientX;
                    const touchY = e.touches[0].clientY;
                    
                    // Calculate new position as percentage
                    let newLeft = originalLeft + ((touchX - startX) / pitchRect.width * 100);
                    let newTop = originalTop + ((touchY - startY) / pitchRect.height * 100);
                    
                    // Constrain to pitch
                    newLeft = Math.max(5, Math.min(95, newLeft));
                    newTop = Math.max(5, Math.min(95, newTop));
                    
                    player.style.left = `${newLeft}%`;
                    player.style.top = `${newTop}%`;
                    e.preventDefault();
                });
                
                document.addEventListener('touchend', function(e) {
                    if (!isDragging) return;
                    isDragging = false;
                    player.style.zIndex = 1;
                });
                
                // Mouse events for desktop/testing
                player.addEventListener('mousedown', function(e) {
                    isDragging = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    originalLeft = parseInt(player.style.left);
                    originalTop = parseInt(player.style.top);
                    player.style.zIndex = 10;
                    e.preventDefault();
                });
                
                document.addEventListener('mousemove', function(e) {
                    if (!isDragging) return;
                    
                    const pitchRect = pitchContainer.getBoundingClientRect();
                    
                    // Calculate new position as percentage
                    let newLeft = originalLeft + ((e.clientX - startX) / pitchRect.width * 100);
                    let newTop = originalTop + ((e.clientY - startY) / pitchRect.height * 100);
                    
                    // Constrain to pitch
                    newLeft = Math.max(5, Math.min(95, newLeft));
                    newTop = Math.max(5, Math.min(95, newTop));
                    
                    player.style.left = `${newLeft}%`;
                    player.style.top = `${newTop}%`;
                });
                
                document.addEventListener('mouseup', function(e) {
                    if (!isDragging) return;
                    isDragging = false;
                    player.style.zIndex = 1;
                });
            });
        }
    });
</script>
{% endblock %}